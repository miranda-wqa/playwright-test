name: Deploy Reports Index to Pages

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Download and organize artifacts by branch
        env:
          GH_TOKEN: ${{ github.token }}
          TARGET_ARTIFACT_NAME: "acceptance-test-results"
        run: |
          mkdir -p _site

          REPO="${GITHUB_REPOSITORY}"

          echo "Fetching latest workflow runs..."
          RUNS=$(gh api "/repos/${REPO}/actions/runs" --paginate -q \
            '.workflow_runs[] | select(.conclusion=="success") | {id, name, head_branch, created_at, html_url}')

          echo "Processing top 50 runs..."
          echo "$RUNS" | jq -s 'sort_by(.created_at) | reverse | .[:50]' | jq -c '.'[] | while read -r RUN; do
            RUN_ID=$(echo "$RUN" | jq -r '.id')
            BRANCH=$(echo "$RUN" | jq -r '.head_branch')
            CREATED=$(echo "$RUN" | jq -r '.created_at' | cut -d'T' -f1)
            HTML_URL=$(echo "$RUN" | jq -r '.html_url')

            echo "Checking run $RUN_ID from branch $BRANCH..."

            gh api "/repos/${REPO}/actions/runs/${RUN_ID}/artifacts" > artifacts.json

            ARTIFACT=$(jq -c ".artifacts[] | select(.name == \"${TARGET_ARTIFACT_NAME}\")" artifacts.json)

            if [ ! -z "$ARTIFACT" ]; then
              ARTIFACT_ID=$(echo "$ARTIFACT" | jq -r '.id')
              ARTIFACT_URL=$(echo "$ARTIFACT" | jq -r '.archive_download_url')
              mkdir -p "_site/${BRANCH}"

              echo "Downloading artifact $ARTIFACT_ID for branch $BRANCH..."
              gh api "$ARTIFACT_URL" --method GET > artifact.zip || continue

              echo "Extracting artifact for branch $BRANCH..."
              unzip -o artifact.zip -d "_site/${BRANCH}" && rm artifact.zip
            fi
          done

          rm -f artifacts.json

          # Generate index
          cat > _site/index.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Acceptance Test Reports</title>
            <style>
              body { font-family: sans-serif; padding: 20px; }
              h2 { margin-top: 40px; }
              ul { line-height: 1.6; }
            </style>
          </head>
          <body>
          <h1>Acceptance Test Reports</h1>
          EOF

          for dir in _site/*/; do
            BRANCH=$(basename "$dir")
            echo "<h2>Branch: $BRANCH</h2>" >> _site/index.html
            echo "<ul>" >> _site/index.html
            for report in "$dir"/*; do
              NAME=$(basename "$report")
              echo "<li><a href=\"${BRANCH}/${NAME}\">${NAME}</a></li>" >> _site/index.html
            done
            echo "</ul>" >> _site/index.html
          done

          echo "</body></html>" >> _site/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
