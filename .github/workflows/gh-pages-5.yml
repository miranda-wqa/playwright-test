name: Generate Artifact Index

on:
  workflow_dispatch:
  push:
    branches: [ main ]
permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: cli/cli-action@v2

      - name: Generate HTML index of artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifact-index
          echo "<html><body><h1>Acceptance Test Artifacts</h1>" > artifact-index/index.html

          gh api --paginate /repos/${{ github.repository }}/actions/artifacts | \
          jq -s -r '
            [.[].artifacts[] | select(.name == "acceptance-test-results" and .expired == false)
             | {name, branch: .workflow_run.head_branch, id: .id, archive_download_url}]
            | group_by(.branch)
            | .[] as $branch_group |
              "<h2>Branch: \($branch_group[0].branch)</h2><ul>" +
              ($branch_group | map("<li><a href=\"" + .archive_download_url + "\">Artifact #\(.id)</a></li>") | join("")) +
              "</ul>"
          ' >> artifact-index/index.html

          echo "</body></html>" >> artifact-index/index.html

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: artifact-index

  deploy:
    needs: build-index
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3
