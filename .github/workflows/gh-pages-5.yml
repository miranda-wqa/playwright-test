name: Test-2

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  actions: read
  contents: read

jobs:
  generate-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate HTML index
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifact-index
          echo "<html><body><h1>Acceptance Test Artifacts</h1>" > artifact-index/index.html

          gh api --paginate /repos/${{ github.repository }}/actions/artifacts | \
          jq -s -r '
            [.[].artifacts[] | select(.name == "acceptance-test-results" and .expired == false)
            | {name, branch: .workflow_run.head_branch, id: .id, archive_download_url}]
            | group_by(.branch)
            | .[] as $branch_group |
              "<h2>Branch: \($branch_group[0].branch)</h2><ul>" +
              ($branch_group | map("<li><a href=\"" + .archive_download_url + "\">Artifact #\(.id)</a></li>") | join("")) +
              "</ul>"
          ' >> artifact-index/index.html

          echo "</body></html>" >> artifact-index/index.html

      - name: Upload index.html as artifact
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-test-index
          path: artifact-index/index.html
