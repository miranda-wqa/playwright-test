name: Deploy Acceptance Test Reports

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read
  actions: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Generate Index Page
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifact-index
          cat > artifact-index/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Acceptance Test Reports</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              h1 { color: #333; }
              h2 { color: #666; margin-top: 20px; }
              ul { list-style-type: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .run-info { color: #666; font-size: 0.9em; }
            </style>
          </head>
          <body>
            <h1>Acceptance Test Reports</h1>
          EOF

          # Fetch all artifacts
          echo "Fetching artifacts..."
          gh api --paginate /repos/${{ github.repository }}/actions/artifacts > raw_artifacts.json
          
          # Process artifacts and generate HTML
          echo "Processing artifacts..."
          gh api --paginate /repos/${{ github.repository }}/actions/artifacts | \
          jq -s '
            add | 
            .artifacts[] | 
            select(.name == "report-folder" and .expired == false) | 
            {
              name,
              branch: .workflow_run.head_branch,
              run_id: .workflow_run.id,
              run_number: .workflow_run.run_number,
              created_at: .created_at,
              id: .id,
              download_url: .archive_download_url
            }
          ' | \
          jq -s '
            group_by(.branch) | 
            sort_by(.[0].branch) | 
            .[] as $branch_group |
              "<h2>Branch: \($branch_group[0].branch)</h2><ul>" +
              ($branch_group | sort_by(.run_id) | reverse | map(
                "<li>" +
                "<a href=\"" + .download_url + "\">Run #\(.run_number)</a> " +
                "<span class=\"run-info\">(ID: \(.id), Created: \(.created_at))</span>" +
                "</li>"
              ) | join("")) +
              "</ul>"
          ' >> artifact-index/index.html

          echo "</body></html>" >> artifact-index/index.html
          
          # Debug: Show the generated HTML
          echo "Generated HTML preview:"
          head -n 20 artifact-index/index.html
          echo "..."
          tail -n 5 artifact-index/index.html

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: artifact-index

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
